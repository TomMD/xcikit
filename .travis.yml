language: cpp
compiler: clang
os: osx
osx_image: xcode11.6

env:
  global:
    - CONAN_REVISIONS_ENABLED=1
    - MACOSX_DEPLOYMENT_TARGET=10.14
    - VK_SDK_VER=1.2.131.2
    - CC=/usr/local/opt/llvm/bin/clang
    - CXX=/usr/local/opt/llvm/bin/clang++

addons:
  homebrew:
    update: false
    packages:
      - llvm
      - conan
      - ccache
      - ninja
      - glfw
      - doxygen
      - google-benchmark

before_script:
  - |
    export VULKAN_SDK="$PWD/vulkansdk-macos-$VK_SDK_VER/macOS"
    if [ ! -d "$VULKAN_SDK" ]; then
      curl -fsSLO https://sdk.lunarg.com/sdk/download/$VK_SDK_VER/mac/vulkansdk-macos-$VK_SDK_VER.tar.gz
      tar xf vulkansdk-macos-$VK_SDK_VER.tar.gz && rm vulkansdk-macos-$VK_SDK_VER.tar.gz
    fi
  - ./bootstrap.sh -y
  - ./build.sh deps

script:
  - ./build.sh config build test install package

after_failure:
  - cat build/*/Testing/Temporary/LastTest.log

before_cache:
  - brew cleanup -s

cache:
  ccache: true
  directories:
    - vulkansdk-macos-$VK_SDK_VER
    - $HOME/Library/Caches/Homebrew
    - /usr/local/Homebrew

before_deploy:
  - conan user -p $CONAN_PASSWORD -r xcikit rbrich
  - conan upload '*/*@rbrich/stable' --all --no-overwrite --check --confirm -r=xcikit

deploy:
  provider: releases
  api_key: $GITHUB_TOKEN
  file_glob: true
  file: artifacts/*.zip
  on:
    repo: rbrich/xcikit
    branch: master
  skip_cleanup: true
  draft: true
